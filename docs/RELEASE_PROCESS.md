# Release Process

**Last Updated:** 2026-02-05  
**Purpose:** Canonical release flow for publishing via CI using semantic-release

---

> âš ï¸ **NO QUICK FIXES POLICY**
>
> There is no such thing as a "quick fix" in this repository.
>
> Any change that touches:
> - package.json version
> - CHANGELOG.md
> - npm publish
> - git tags
>
> MUST go through the automated release process.
>
> Manual edits or "temporary fixes" are forbidden,
> as they permanently corrupt version canon.

---

> ðŸ”’ **CI-ONLY PUBLISH**
>
> **`npm publish` is forbidden locally.** Publication happens only in GitHub Actions CI.
> Local scripts are for preparation and validation only.

---

## Overview

This project uses **semantic-release** in GitHub Actions. Releases are triggered by **pushes to `main`** and are fully automated.

**Key Principles:**
- npm registry is the single source of truth for published versions
- CHANGELOG is generated by CI, not edited manually
- git tags are created by semantic-release (tag format: `vX.Y.Z`)
- publish is CI-only and requires CI secrets

**CI release workflow:** `.github/workflows/release.yml` runs on `main` and executes `npx semantic-release`.

**Release configuration:** `release.config.cjs` defines:
- `branches: ["main"]`
- `tagFormat: "v${version}"`
- changelog generation
- npm publish
- GitHub release with assets
- commit of `CHANGELOG.md` and `package.json` back to `main`

---

## Quick Start

1. Use **Conventional Commits** in your PRs (details below).
2. Merge to `main`.
3. CI runs semantic-release and publishes if a release is warranted.

No manual version bump. No manual tag creation.

---

## Step-by-Step Release Flow

### Step 1: Write Conventional Commits

semantic-release decides versions from commit messages.

**Supported types (examples):** `feat`, `fix`, `perf`, `refactor`, `docs`, `chore`, `ci`, `test`, `build`.

**Breaking changes:**
- Use `!` in the type: `feat!: ...`
- Or add a `BREAKING CHANGE:` footer

If there are **no release-worthy commits**, semantic-release will skip publishing.

### Step 2: Merge to `main`

Release workflow triggers on `push` to `main`.

### Step 3: CI Performs the Release

The release workflow:
- Installs dependencies
- Builds the package
- Creates build provenance attestation for `dist/**`
- Runs `npx semantic-release`

semantic-release then:
- Analyzes commits
- Generates release notes
- Updates `CHANGELOG.md`
- Bumps `package.json` version
- Creates a git tag `vX.Y.Z`
- Publishes to npm
- Creates a GitHub release and uploads assets
- Commits `CHANGELOG.md` and `package.json` back to `main`

---

## Local Preparation (Optional)

Recommended pre-flight checks before merging:

```bash
pnpm validate
pnpm build
pnpm test
```

These are **optional** but reduce CI failures.

---

## Legacy Scripts (Not Part of CI Release)

The following scripts exist but are **not used** by the current CI release pipeline:

```bash
pnpm release:check
pnpm release:prepare
pnpm release:verify
```

Do not rely on these for publishing. The canonical release path is semantic-release in CI.

---

## Troubleshooting

### No Release Was Published

**Common causes:**
- Commit messages are not Conventional Commits
- Only `docs`, `chore`, or other non-release types were merged

**Fix:**
- Ensure release-worthy commits (`feat`, `fix`, `perf`, or breaking changes)
- Re-run by pushing a new commit to `main`

### CI Release Job Failed

**Check:**
- GitHub Actions logs for the Release workflow
- `npx semantic-release` output (reason for failure)

**Fix:**
- Address the reported error
- Push a new commit to `main`

### npm Publish Failed

**Check:**
- `NPM_TOKEN` secret exists and is valid
- Package access is `public`
- npm account has publish rights for `@tenerife.music/ui`

**Fix:**
- Update `NPM_TOKEN` and re-run workflow

### Tag or GitHub Release Missing

**Check:**
- `GITHUB_TOKEN` permissions (workflow has `contents: write`)
- semantic-release logs for tag or GitHub release step failures

**Fix:**
- Re-run workflow after fixing permissions

---

## Canonical References

- Release workflow: `.github/workflows/release.yml`
- Release config: `release.config.cjs`
- CHANGELOG: `CHANGELOG.md`

