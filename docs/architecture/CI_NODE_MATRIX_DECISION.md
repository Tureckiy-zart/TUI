# CI Node.js Matrix — Архитектурное решение

**Дата:** 2025-01-19  
**Статус:** Canonical  
**Область:** CI/CD, GitHub Actions

---

## Контекст

В проекте Tenerife UI используется matrix strategy в GitHub Actions для тестирования на нескольких версиях Node.js. Данный документ фиксирует осознанное понимание архитектуры CI matrix и принятое решение о поддерживаемых версиях Node.js.

**Текущая конфигурация:** `.github/workflows/ci.yml` использует matrix с версиями `[18.x, 20.x, 22.x]`

---

## Ответы на вопросы понимания

### TUNG_CI_NODE_Q1: Это три разных CI или один CI с matrix?

**Ответ:** Это **один workflow с matrix strategy**, а не три независимых CI.

**Техническое объяснение:**

- **Matrix strategy** — это механизм GitHub Actions, который позволяет запускать один и тот же набор шагов (job) с различными параметрами в рамках одного workflow.
- В `.github/workflows/ci.yml` определен один job `quality` с `strategy.matrix.node-version: [18.x, 20.x, 22.x]`.
- GitHub Actions автоматически создает **три параллельных выполнения** (runs) этого job, по одному для каждой версии Node.js.
- Все три выполнения используют **одинаковые шаги** (lint, format:check, typecheck), но выполняются на разных версиях Node.js.

**Разница с тремя независимыми CI:**

| Аспект | Matrix Strategy (текущий) | Три независимых CI |
|--------|---------------------------|---------------------|
| Конфигурация | Один workflow, одна матрица | Три отдельных workflow |
| Поддержка | Изменения в одном месте | Изменения в трех местах |
| Параллелизм | Автоматический | Требует настройки |
| Ресурсы | Один job с тремя runs | Три отдельных jobs |

**Вывод:** Matrix strategy упрощает поддержку и обеспечивает консистентность проверок на всех версиях Node.js.

---

### TUNG_CI_NODE_Q2: Что реально отличает Node.js 18.x от 20.x в контексте UI-библиотеки?

**Ответ:** Различия на уровне LTS-статуса, runtime, V8, ESM/CJS, стабильности экосистемы и рисков для потребителей библиотеки.

#### 1. LTS-статус и поддержка

- **Node.js 18.x:**
  - EOL (End of Life): **30 апреля 2025** (через ~3 месяца)
  - После EOL не будет обновлений безопасности и исправлений
  - Текущий статус: Maintenance LTS (до EOL)

- **Node.js 20.x:**
  - Активная LTS до **апреля 2026**
  - Полная поддержка безопасности и исправлений
  - Рекомендуемая версия для production

- **Node.js 22.x:**
  - Current (не LTS)
  - Станет LTS в октябре 2024 → апрель 2025
  - Может содержать breaking changes

#### 2. Runtime и V8

- **Node.js 18.x:** V8 10.2
- **Node.js 20.x:** V8 11.3+
- **Node.js 22.x:** V8 12.2+

**Влияние на UI-библиотеку:**
- Более новые версии V8 могут иметь различия в:
  - Обработке async/await
  - Производительности регулярных выражений
  - Оптимизациях компиляции JavaScript
- Для **npm package** (компилируемой библиотеки) это менее критично, чем для runtime-приложений, так как код компилируется в `dist/` и не выполняется напрямую в Node.js потребителя.

#### 3. ESM/CJS поддержка

- **Node.js 18.x:** Базовая поддержка ESM, `package.json` `"type": "module"` работает стабильно
- **Node.js 20.x:** Улучшенная поддержка ESM, лучшая обработка `exports` в `package.json`
- **Node.js 22.x:** Дальнейшие улучшения ESM

**Влияние на Tenerife UI:**
- Проект использует `"type": "module"` в `package.json`
- Библиотека компилируется в `dist/` с поддержкой CJS и ESM (`index.cjs`, `index.mjs`)
- **Потребители библиотеки** могут использовать любую версию Node.js, так как они получают уже скомпилированные файлы
- **CI тестирует процесс сборки**, а не runtime выполнения библиотеки

#### 4. Стабильность экосистемы

- **Node.js 18.x:**
  - Многие пакеты начинают прекращать поддержку
  - Риск несовместимости с новыми версиями dev-зависимостей
  - Пример: `@types/node@^20.19.25` в проекте уже указывает на Node 20+

- **Node.js 20.x:**
  - Стандарт для большинства современных проектов
  - Полная поддержка всех актуальных инструментов (pnpm, vite, tsup, vitest)

- **Node.js 22.x:**
  - Может иметь нестабильности в некоторых инструментах
  - Некоторые пакеты могут еще не поддерживать полностью

#### 5. Риски для потребителей библиотеки

**Ключевой момент:** Tenerife UI — это **npm package**, который:
- Компилируется в `dist/` на этапе разработки
- Потребители получают уже скомпилированные `.cjs` и `.mjs` файлы
- Потребители **не выполняют исходный код библиотеки** в Node.js

**Реальные риски:**
- ❌ **Минимальные** — потребители используют библиотеку в браузере или в своих приложениях с любой версией Node.js
- ✅ **Основной риск** — процесс **разработки и сборки** библиотеки должен работать на поддерживаемых версиях Node.js

**Вывод:** Для UI-библиотеки различия между Node.js 18/20/22 в runtime менее критичны, чем для runtime-приложений. Основная цель CI matrix — убедиться, что **процесс сборки и тестирования** работает на разных версиях Node.js.

---

### TUNG_CI_NODE_Q3: Какой вариант поддержки Node выбрать и почему?

**Решение:** **Вариант B — Оставить 18.x + 20.x** (с пометкой 18.x как non-blocking до EOL)

#### Анализ вариантов

##### Вариант A: 18.x + 20.x + 22.x

**Плюсы:**
- Максимальная совместимость
- Раннее обнаружение проблем с новыми версиями

**Минусы:**
- Node.js 18.x EOL через ~3 месяца (апрель 2025)
- Node.js 22.x еще не LTS (станет в апреле 2025)
- Увеличение времени CI (3 параллельных выполнения)
- Риск ложных срабатываний на нестабильных версиях

**Вердикт:** Избыточно для библиотеки, которая компилируется в `dist/`.

##### Вариант B: 18.x + 20.x

**Плюсы:**
- Поддержка текущей LTS (20.x) и предыдущей LTS (18.x до EOL)
- Баланс между совместимостью и эффективностью CI
- Покрывает большинство пользователей

**Минусы:**
- Node.js 18.x скоро EOL (апрель 2025)
- Не покрывает Node.js 22.x (но это не критично до его LTS)

**Вердикт:** Оптимальный баланс для текущего момента.

##### Вариант C: Только 20.x

**Плюсы:**
- Простота и скорость CI
- Фокус на актуальной LTS
- Минимизация ложных срабатываний

**Минусы:**
- Может исключить пользователей на Node.js 18.x (до EOL)
- Не покрывает будущую LTS (22.x)

**Вердикт:** Слишком агрессивно для библиотеки, которая должна поддерживать широкую аудиторию.

#### Обоснование выбора: Вариант B

**Аргументы:**

1. **Статус Node.js 18.x:**
   - EOL в апреле 2025 (через ~3 месяца)
   - До EOL имеет смысл поддерживать для пользователей на legacy-системах
   - После EOL можно безопасно убрать

2. **Статус Node.js 20.x:**
   - Активная LTS до апреля 2026
   - Стандарт для production
   - Должен быть **обязательным** (blocking) в CI

3. **Статус Node.js 22.x:**
   - Еще не LTS (станет в апреле 2025)
   - Можно добавить позже, когда станет LTS
   - Сейчас не критично для библиотеки

4. **Характер проекта:**
   - UI-библиотека компилируется в `dist/`
   - Потребители не выполняют исходный код в Node.js
   - Основная цель CI — проверить процесс сборки, а не runtime

5. **Эффективность CI:**
   - 2 версии вместо 3 = быстрее CI
   - Меньше ложных срабатываний
   - Проще поддержка

6. **Рекомендация по 18.x:**
   - Пометить как **non-blocking** (continue-on-error: true) до EOL
   - После EOL (апрель 2025) убрать из matrix
   - Это позволит мониторить совместимость без блокировки CI

#### План миграции

1. **Сейчас (январь 2025):**
   - Matrix: `[18.x, 20.x]`
   - 18.x: `continue-on-error: true` (non-blocking)
   - 20.x: blocking (обязательный)

2. **После EOL Node.js 18.x (май 2025):**
   - Убрать 18.x из matrix
   - Оставить только 20.x (blocking)

3. **После LTS Node.js 22.x (май 2025):**
   - Добавить 22.x в matrix (blocking)
   - Итоговая конфигурация: `[20.x, 22.x]`

---

## Итоговое решение

**Выбранный вариант:** **B — 18.x + 20.x** (с 18.x как non-blocking)

**Конфигурация:**
```yaml
jobs:
  quality:
    name: Quality Checks (Node ${{ matrix.node-version }})${{ matrix.node-version == '18.x' && ' [Legacy]' || ' [BLOCKING]' }}
    continue-on-error: ${{ matrix.node-version == '18.x' }}
    strategy:
      matrix:
        node-version: [18.x, 20.x]
```

**Canonical naming:**
- Node.js 18.x: `Quality Checks (Node 18.x) [Legacy]` — non-blocking
- Node.js 20.x: `Quality Checks (Node 20.x) [BLOCKING]` — blocking

**Обоснование:**
- Баланс между совместимостью и эффективностью
- Поддержка пользователей на Node.js 18.x до EOL
- Фокус на стабильной LTS (20.x)
- Готовность к миграции после EOL 18.x

---

## Следующие шаги

1. ✅ Обновить `.github/workflows/ci.yml` с выбранной конфигурацией
2. ✅ Обновить `docs/CI_CD_OVERVIEW.md` с новым решением
3. ✅ Зафиксировать план миграции (удаление 18.x после EOL)
4. ✅ Применить canonical naming для всех CI checks
5. ✅ Разделить checks на blocking и informational

## Canonical CI Naming

Все CI checks используют единый формат naming с явными маркерами:

- **`[BLOCKING]`** — обязательная проверка, блокирует PR
- **`[Legacy]`** — устаревшая версия (до удаления), non-blocking
- **`[Informational]`** — информационная проверка, не блокирует PR
- **`[Main Only]`** — выполняется только на main branch

**Примеры canonical naming:**
- `Quality Checks (Node 20.x) [BLOCKING]`
- `Quality Checks (Node 18.x) [Legacy]`
- `Build Package [BLOCKING]`
- `Storybook Build [Informational]`
- `Chromatic Visual Tests [Informational]`

---

**Документ создан:** 2025-01-19  
**Статус:** Canonical — решение принято и зафиксировано

