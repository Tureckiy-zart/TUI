# –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
if [ -n "$SKIP_PRE_COMMIT" ]; then
  exit 0
fi

echo "üîß PRE-COMMIT: Running auto-fixes on staged files..."

# –ó–∞–ø—É—Å–∫–∞–µ–º lint-staged –¥–ª—è –∞–≤—Ç–æ—Ñ–∏–∫—Å–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
# lint-staged –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ staging area
# lint-staged —Ç–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç theme:validate –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ç–µ–º
pnpm lint-staged

echo "‚úÖ Pre-commit auto-fixes completed!"

# ============================================================================
# Theme Token Parity Check
# If CSS theme files are modified, ensure all themes have the same token set
# ============================================================================

# Check if any Foundation CSS theme files are staged
STAGED_FOUNDATION_THEME_CSS=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^src/FOUNDATION/tokens/themes/.*\.css$' || true)

# Check if any Extension theme files are staged
STAGED_EXTENSION_THEMES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^src/EXTENSIONS/themes/.*\.(css|json|ts)$' || true)

if [ -n "$STAGED_FOUNDATION_THEME_CSS" ] || [ -n "$STAGED_EXTENSION_THEMES" ]; then
  echo ""
  echo "üé® PRE-COMMIT: Theme files detected, running parity check..."
  
  if ! pnpm theme:parity-check; then
    echo ""
    echo "‚ùå Theme token parity check failed!"
    echo "üí° All theme CSS files must define exactly the same set of tokens."
    echo "   See: src/FOUNDATION/tokens/required-tokens.ts"
    echo ""
    exit 1
  fi
  
  echo "‚úÖ Theme token parity check passed!"
fi

# ============================================================================
# Extension Theme Validation
# If Extension theme files are modified, validate them against Theme Contract v1
# ============================================================================

if [ -n "$STAGED_EXTENSION_THEMES" ]; then
  echo ""
  echo "üé® PRE-COMMIT: Extension theme files detected, running validation..."
  
  if ! pnpm theme:validate:extension; then
    echo ""
    echo "‚ùå Extension theme validation failed!"
    echo "üí° All Extension themes must comply with Theme Contract v1."
    echo "   See: docs/theming/THEME_EXTENSION_CONTRACT.md"
    echo ""
    exit 1
  fi
  
  echo "‚úÖ Extension theme validation passed!"
fi
